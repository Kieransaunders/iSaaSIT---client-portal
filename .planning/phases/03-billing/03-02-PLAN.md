---
phase: 03-billing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/billing/queries.ts
  - convex/billing/actions.ts
autonomous: true
user_setup:
  - service: lemonsqueezy
    why: "Server-side API calls for checkout and cancellation"
    env_vars:
      - name: LEMONSQUEEZY_API_KEY
        source: "Lemon Squeezy Dashboard -> Settings -> API -> API keys"
      - name: LEMONSQUEEZY_STORE_ID
        source: "Lemon Squeezy Dashboard -> Settings -> Stores -> Store ID"

must_haves:
  truths:
    - "Admin can request a checkout URL for a specific plan variant"
    - "Admin can cancel an existing subscription"
    - "Billing query returns real customer/staff/client counts from database"
    - "Billing query returns org subscription status and plan name"
    - "Non-admin users cannot create checkouts or cancel subscriptions"
  artifacts:
    - path: "convex/billing/queries.ts"
      provides: "Usage stats and billing info queries"
      exports: ["getUsageStats", "getBillingInfo"]
    - path: "convex/billing/actions.ts"
      provides: "Checkout URL creation and subscription cancellation"
      exports: ["createCheckoutUrl", "cancelSubscription"]
  key_links:
    - from: "convex/billing/queries.ts"
      to: "convex schema orgs table"
      via: "reads subscription fields and counts entities"
      pattern: "ctx.db.query.*orgs|customers|users"
    - from: "convex/billing/actions.ts"
      to: "@lemonsqueezy/lemonsqueezy.js"
      via: "SDK calls for checkout and cancellation"
      pattern: "lemonSqueezySetup|cancelSubscription"
---

<objective>
Create billing backend operations: usage statistics queries and Lemon Squeezy API actions for checkout and cancellation.

Purpose: The billing page and upgrade prompts need data (usage counts, plan info) and the ability to trigger checkout and cancel subscriptions. This plan provides the server-side API surface for all billing UI interactions.

Output: Convex queries for billing data and actions for Lemon Squeezy API operations (create checkout URL, cancel subscription).
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing/03-RESEARCH.md

Key existing code to reference:
@convex/schema.ts (org table fields, users table with role/orgId, customers table)
@convex/orgs/get.ts (pattern for authenticated queries, getMyOrg pattern)
@convex/invitations/internal.ts (getOrgUserCounts pattern for counting users by role)
@convex/invitations/send.ts (pattern for "use node" actions with WorkOS SDK)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create billing usage and info queries</name>
  <files>convex/billing/queries.ts</files>
  <action>
Create `convex/billing/queries.ts`:

Install the Lemon Squeezy SDK first: `npm install @lemonsqueezy/lemonsqueezy.js`

**`getUsageStats` query:**
- Authenticated query (same pattern as `convex/orgs/get.ts:getMyOrg`)
- Get user identity, look up user record by workosUserId, get orgId
- Throw ConvexError if not authenticated or no org
- Count customers: query `customers` table by `by_org` index
- Count staff: query `users` table by `by_org` index, filter `role === "staff"` and `deletedAt === undefined`
- Count clients: query `users` table by `by_org` index, filter `role === "client"` and `deletedAt === undefined`
- Count pending staff invitations: query `pendingInvitations` by `by_org` index, filter `role === "staff"`
- Count pending client invitations: query `pendingInvitations` by `by_org` index, filter `role === "client"`
- Get org for limits (maxCustomers, maxStaff, maxClients)
- Return structured object:
  ```
  {
    plan: {
      name: string,        // from getPlanName(org.planId)
      status: string,      // org.subscriptionStatus || "inactive"
      planId: string | undefined,
    },
    usage: {
      customers: { count: number, max: number },
      staff: { count: number, max: number },      // count includes pending
      clients: { count: number, max: number },     // count includes pending
    },
  }
  ```
- Import `getPlanName` from `../lemonsqueezy/plans` -- NOTE: this file will be created by plan 03-01 in parallel. If it doesn't exist yet at compile time, create a temporary inline helper that returns "Free" for undefined planId, "Pro" for known pro variant, etc. The parallel plan will create the canonical version.
- IMPORTANT: Since Plan 01 creates `convex/lemonsqueezy/plans.ts` in parallel, and this plan needs `getPlanName`, take one of two approaches:
  1. If Plan 01 has already run: import from `../lemonsqueezy/plans`
  2. If Plan 01 hasn't run yet: define a local `getPlanName` function inline (will be replaced when wiring up in Plan 03)

**`getBillingInfo` query:**
- Authenticated query, admin-only (check role === "admin")
- Returns org billing fields: subscriptionId, subscriptionStatus, planId, plus org name and workosOrgId
- Used by billing page to determine current state (show upgrade vs manage subscription)
  </action>
  <verify>
Run `npx convex dev --once` to verify compilation. Check that getUsageStats counts include pending invitations. Check getBillingInfo enforces admin role.
  </verify>
  <done>
getUsageStats returns real counts (customers, staff+pending, clients+pending) against org limits. getBillingInfo returns subscription state for billing page. Both enforce authentication; getBillingInfo additionally requires admin role.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create checkout and cancel subscription actions</name>
  <files>convex/billing/actions.ts</files>
  <action>
Create `convex/billing/actions.ts`:

This file needs `"use node"` directive at the top (same pattern as `convex/invitations/send.ts`) because it imports the Lemon Squeezy SDK which requires Node.js runtime.

**`createCheckoutUrl` action:**
- Args: `variantId: v.string()` (the Lemon Squeezy variant ID for the plan)
- Get authenticated user, look up user record via internal query
- Verify user is admin role
- Get org details via internal query
- Build checkout URL manually (string construction, not SDK -- the SDK's `createCheckout` requires a store ID and returns complex objects):
  ```
  const checkoutUrl = new URL(`https://${STORE_SLUG}.lemonsqueezy.com/checkout/buy/${variantId}`);
  checkoutUrl.searchParams.set("checkout[email]", userRecord.email);
  checkoutUrl.searchParams.set("checkout[name]", org.name);
  checkoutUrl.searchParams.set("checkout[custom][org_convex_id]", org._id);
  ```
- Use env var `LEMONSQUEEZY_STORE_SLUG` for store slug (e.g., "mystore") -- add to user_setup if not already
- ACTUALLY: Per research, use the Lemon Squeezy SDK `createCheckout` instead for proper server-side creation. BUT checkout overlay uses URLs directly. So build the URL string for use with `LemonSqueezy.Url.Open()`.
- CORRECTION: The simplest approach: return a checkout URL string. The frontend will open it via Lemon.js overlay. Build URL with variant ID and pre-filled data.
- Store slug should come from env var `LEMONSQUEEZY_STORE_SLUG`
- Return `{ checkoutUrl: string }` for the frontend to open via Lemon.js

**`cancelSubscription` action:**
- Args: none (cancels current org's subscription)
- Get authenticated user, verify admin role
- Get org via internal query, verify org has subscriptionId
- Initialize Lemon Squeezy SDK: `lemonSqueezySetup({ apiKey: process.env.LEMONSQUEEZY_API_KEY! })`
- Call `cancelSubscription(org.subscriptionId)` from `@lemonsqueezy/lemonsqueezy.js`
- If error, throw ConvexError with message
- Return `{ success: true, endsAt: result.data.data.attributes.ends_at }` so UI can show when access expires
- NOTE: The actual status update happens via webhook (subscription_cancelled event), not here. This action just initiates cancellation with Lemon Squeezy.

Both actions need internal queries to get user records and org. Reuse `internal.invitations.internal.getUserRecord` for user lookup, and `internal.orgs.get.getMyOrgInternal` for org lookup.
  </action>
  <verify>
Run `npx convex dev --once` to verify compilation. Check that:
1. File has "use node" directive
2. createCheckoutUrl builds URL with pre-filled email, name, and org_convex_id custom data
3. cancelSubscription uses official SDK's cancelSubscription function
4. Both actions verify admin role before proceeding
  </verify>
  <done>
createCheckoutUrl returns a pre-filled Lemon Squeezy checkout URL for a given variant. cancelSubscription calls Lemon Squeezy API to initiate cancellation. Both enforce admin-only access. Checkout URL includes custom data (org_convex_id) for webhook correlation.
  </done>
</task>

</tasks>

<verification>
1. `npx convex dev --once` succeeds
2. `npm install @lemonsqueezy/lemonsqueezy.js` added to dependencies
3. getUsageStats returns usage with pending invitations counted
4. createCheckoutUrl includes org_convex_id in custom data for webhook correlation
5. cancelSubscription uses official SDK (not raw fetch)
6. All functions enforce authentication and admin authorization
</verification>

<success_criteria>
- Billing queries return real usage data from Convex database
- Checkout URL action builds pre-filled Lemon Squeezy URL with org correlation data
- Cancel action calls Lemon Squeezy API and returns end date
- All operations enforce admin-only access
- SDK installed and "use node" directive present for actions file
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-02-SUMMARY.md`
</output>
