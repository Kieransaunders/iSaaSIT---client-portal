---
phase: 03-billing
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Admin clicks Upgrade -> Lemon Squeezy checkout overlay opens with pre-filled email"
    - "After payment -> org subscription status is active (via webhook)"
    - "Plan caps updated from subscription (maxCustomers, maxStaff, maxClients)"
    - "Billing page shows real counts vs limits with colored progress bars"
    - "Creating customer blocked at limit with upgrade prompt"
    - "Warning banner appears when at 80%+ of any limit"
    - "Cancel subscription shows confirmation and processes via API"
---

<objective>
End-to-end verification of the complete billing system.

Purpose: Confirm all billing components work together: checkout overlay, webhook processing, plan cap enforcement, billing dashboard, and subscription management. This is the user acceptance checkpoint for the entire phase.

Output: Verified billing flow from checkout through cap enforcement.
</objective>

<execution_context>
@/Users/boss/.claude/get-shit-done/workflows/execute-plan.md
@/Users/boss/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-billing/03-01-SUMMARY.md
@.planning/phases/03-billing/03-02-SUMMARY.md
@.planning/phases/03-billing/03-03-SUMMARY.md
@.planning/phases/03-billing/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Compile and deploy verification</name>
  <files></files>
  <action>
Run full build verification:
1. `npx convex dev --once` -- verify all Convex functions compile and deploy
2. `npx tsc --noEmit` -- verify all TypeScript compiles without errors
3. `npm run build` -- verify frontend builds successfully
4. Check that convex/http.ts is deployed with webhook route
5. Verify all new files exist:
   - convex/http.ts
   - convex/lemonsqueezy/webhook.ts
   - convex/lemonsqueezy/signature.ts
   - convex/lemonsqueezy/sync.ts
   - convex/lemonsqueezy/plans.ts
   - convex/billing/queries.ts
   - convex/billing/actions.ts
   - src/components/billing/UpgradeButton.tsx
   - src/components/billing/UsageProgress.tsx
   - src/components/billing/CapReachedBanner.tsx
6. Verify no lint errors: `npm run lint` (fix any issues found)
  </action>
  <verify>All build commands exit with 0. All files exist. No lint errors.</verify>
  <done>Full codebase compiles, builds, and passes linting.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete billing system: Lemon Squeezy checkout overlay, webhook processing, plan cap enforcement, billing dashboard, usage warnings</what-built>
  <how-to-verify>
**Billing Dashboard (navigate to /billing):**
1. Page loads with real usage data (not hardcoded zeros)
2. Current plan shows "Free" with correct limits
3. Usage bars are color-coded (green if under 80%)
4. Three plan cards displayed: Free ($0), Pro ($29), Business ($99)

**Checkout Flow:**
5. Click "Upgrade" on Pro or Business card
6. Lemon Squeezy checkout overlay appears in-app (not a redirect)
7. Email and org name are pre-filled in checkout
8. Close overlay without completing payment

**Cap Enforcement:**
9. If at customer limit: go to /customers, try to create a customer
10. Inline upgrade prompt should appear with disabled submit button
11. If NOT at limit: create customers until at limit, then verify prompt appears

**Warning Banner:**
12. If at 80%+ of any limit: verify amber warning banner appears at top of page
13. Banner should link to /billing page

**Webhook Setup (if Lemon Squeezy test mode configured):**
14. Complete a test payment through the overlay
15. Verify org subscription status updates to "active" in billing page
16. Verify plan caps increase (e.g., from 3 to 25 customers for Pro)

**Cancel Flow (if subscription active):**
17. Click "Cancel Subscription" button on billing page
18. Confirmation dialog appears with explanation text
19. Dismiss dialog (don't actually cancel unless testing)

NOTE: If Lemon Squeezy is not configured yet (no API keys/webhook secret), steps 5-8 and 14-19 can be deferred. The page structure, data queries, cap enforcement, and warning banners should all work without Lemon Squeezy configuration.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 3, or describe issues for gap closure</resume-signal>
</task>

</tasks>

<verification>
Phase 3 requirements checklist:
- BILL-01: Org has subscription status synced from Lemon Squeezy -> webhook handler processes events and updates org fields
- BILL-02: Admin can upgrade via Lemon Squeezy checkout -> UpgradeButton opens overlay
- BILL-03: Webhook handler processes subscription events -> convex/lemonsqueezy/webhook.ts with signature verification
- BILL-04: Plan caps update on subscription change -> sync.ts maps variant ID to limits
- BILL-05: Usage cap enforced on staff/client creation -> existing enforcement + inline upgrade prompts
- BILL-06: Billing page shows real usage from Convex -> getUsageStats query wired to billing page
</verification>

<success_criteria>
All 6 BILL requirements verified:
1. Webhook infrastructure deployed and processing events
2. Checkout overlay opens with pre-filled data
3. Subscription events update org status and caps
4. Billing page shows live usage data with colored progress bars
5. Cap enforcement blocks creation with inline upgrade prompt
6. Warning banner shows at 80%+ usage
</success_criteria>

<output>
After completion, create `.planning/phases/03-billing/03-05-SUMMARY.md`
</output>
